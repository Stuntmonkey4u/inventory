<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Enhanced Network Inventory Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Theme toggle styles -->
  <style>
    body {
      padding: 20px;
      transition: background-color 0.3s, color 0.3s;
    }
    body.light-mode {
      background-color: #f5f7fa;
      color: #333;
    }
    body.dark-mode {
      background-color: #1e1e2f;
      color: #ccc;
    }
    .card { margin-bottom: 20px; }
    .pre-scroll {
      max-height: 300px;
      overflow-y: auto;
      font-size: 0.9em;
    }
    summary {
      font-weight: bold;
      background-color: #007bff;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      margin: 10px 0;
      cursor: pointer;
    }
    summary:hover { background-color: #0056b3; }
    .summary-card { min-height: 120px; }
    .theme-toggle {
      cursor: pointer;
    }
  </style>
</head>
<body class="dark-mode">
  <div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1>Network Audit Report</h1>
        <p class="lead">Comprehensive status snapshot of all connected systems.</p>
      </div>
      <div>
        <button class="btn btn-outline-secondary theme-toggle" onclick="toggleTheme()">Toggle Theme</button>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
      {% set total_hosts = report_data | length %}
      {% set total_upgradable = 0 %}
      {% for key, host in report_data.items() %}
        {% set total_upgradable = total_upgradable + (host.upgradable_packages | length) %}
      {% endfor %}

      <div class="col-md-4 summary-card">
        <div class="card text-white bg-primary">
          <div class="card-body">
            <h5>Total Hosts</h5>
            <p class="fs-3">{{ total_hosts }}</p>
          </div>
        </div>
      </div>
      <div class="col-md-4 summary-card">
        <div class="card text-white bg-danger">
          <div class="card-body">
            <h5>Hosts With Updates</h5>
            <p class="fs-3">{{ total_upgradable }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Detailed Host Reports -->
    {% for hostname, host in report_data.items() %}
    <div class="card mb-4">
      <div class="card-header" data-bs-toggle="collapse" data-bs-target="#host-{{ hostname | replace(' ', '-') }}">
        <h4 class="mb-0">{{ hostname }} ({{ host.os }})</h4>
      </div>
      <div id="host-{{ hostname | replace(' ', '-') }}" class="collapse">
        <div class="card-body">
          <!-- Basic Host Info -->
          <div class="row mb-3">
            <div class="col-md-6"><strong>Hostname:</strong> {{ host.hostname }}</div>
            <div class="col-md-6"><strong>IP Address:</strong> {{ host.ip }}</div>
            <div class="col-md-6"><strong>Uptime:</strong> {{ host.uptime }}</div>
            <div class="col-md-6"><strong>Boot Time:</strong> {{ host.boot_time }}</div>
          </div>

          <!-- Verified Running Services (Top 20) -->
          <h5>Verified Running Services (Top 20)</h5>
          {% if host.verified_services %}
            <div class="table-responsive">
              <table class="table table-striped table-sm">
                <thead>
                  <tr>
                    <th>Service</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for line in host.verified_services[:20] %}
                    {% set parts = line.split() %}
                    <tr>
                      <td>{% if parts|length > 0 %}{{ parts[0] }}{% else %}N/A{% endif %}</td>
                      <td>{% if parts|length > 1 %}{{ parts[1] }}{% else %}Running{% endif %}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-muted">No verified running service data found.</p>
          {% endif %}

          <!-- All Services -->
          <h5>All Services</h5>
          {% if host.all_services %}
            <details>
              <summary>Show all {{ host.all_services | length }} services</summary>
              <pre>{{ host.all_services | join('\n') }}</pre>
            </details>
          {% else %}
            <p class="text-muted">No complete service data found.</p>
          {% endif %}

          <!-- Installed Packages -->
          <h5>Installed Packages</h5>
          {% if host.packages %}
            <pre>{{ host.packages[:20] | join('\n') }}</pre>
            {% if host.packages | length > 20 %}
              <details>
                <summary>Show all {{ host.packages | length }} packages</summary>
                <pre>{{ host.packages | join('\n') }}</pre>
              </details>
            {% endif %}
          {% else %}
            <p class="text-muted">No package data found.</p>
          {% endif %}

          <!-- Docker Containers -->
          <h5>Docker Containers</h5>
          {% if host.docker %}
            <pre>{{ host.docker | join('\n') }}</pre>
          {% else %}
            <p class="text-muted">No Docker data found or Docker not installed.</p>
          {% endif %}

          <!-- Upgradable Packages -->
          <h5>Upgradable Packages</h5>
          {% if host.upgradable_packages %}
            <pre>{{ host.upgradable_packages | join('\n') }}</pre>
          {% else %}
            <p class="text-muted">No upgradable packages found.</p>
          {% endif %}

          <!-- Filesystem Usage -->
          <h5>Filesystem Usage</h5>
          {% if host.filesystem %}
            <details>
              <summary>Show Filesystem Usage</summary>
              <pre>{{ host.filesystem | join('\n') }}</pre>
            </details>
          {% else %}
            <p class="text-muted">No filesystem usage data found.</p>
          {% endif %}

          <!-- Listening Ports -->
          <h5>Listening Ports</h5>
          {% if host.listening_ports %}
            <details>
              <summary>Show Listening Ports</summary>
              <pre>{{ host.listening_ports | join('\n') }}</pre>
            </details>
          {% else %}
            <p class="text-muted">No listening ports data found.</p>
          {% endif %}

          <!-- Firewall Rules -->
          <h5>Firewall Rules</h5>
          {% if host.firewall_rules %}
            <details>
              <summary>Show Firewall Rules</summary>
              <pre>{{ host.firewall_rules | join('\n') }}</pre>
            </details>
          {% else %}
            <p class="text-muted">No firewall rules data found.</p>
          {% endif %}

          <!-- Login History -->
          <h5>Login History</h5>
          {% if host.login_history %}
            <details>
              <summary>Show Login History</summary>
              <pre>{{ host.login_history | join('\n') }}</pre>
            </details>
          {% else %}
            <p class="text-muted">No login history data found.</p>
          {% endif %}

          <!-- Root Cron Jobs -->
          <h5>Root Cron Jobs</h5>
          {% if host.cron_jobs %}
            <details>
              <summary>Show Cron Jobs</summary>
              <pre>{{ host.cron_jobs | join('\n') }}</pre>
            </details>
          {% else %}
            <p class="text-muted">No cron jobs found.</p>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  
  <!-- Bootstrap JS bundle for collapse components -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Dark/Light Mode Toggle Script -->
  <script>
    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      document.body.classList.toggle('light-mode');
    }
  </script>
</body>
</html>
